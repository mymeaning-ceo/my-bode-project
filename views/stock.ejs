<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>📦 재고 관리</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap & DataTables -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
    rel="stylesheet"
  />
  <style>
    td, th {
      text-align: center;
      vertical-align: middle;
    }
  
    td, th {
      text-align: center;
      vertical-align: middle;
    }
  
    td.low-stock {
      background-color: #ffe5e5 !important;
      font-weight: bold;
      color: #d8000c;
    }
  </style>
</head>
<body class="bg-light">
  <%- include('nav.ejs') %>

  <div class="container my-5">

    <h2 class="fw-bold mb-4">📦 재고 관리</h2>

    <!-- 검색·버튼 영역 -->
    <div class="row g-2 mb-3">
      <div class="col-sm-6 col-md-4">
        <input
          id="keyword"
          class="form-control"
          placeholder="상품명 또는 상품코드"
        />
      </div>
      <div class="col-auto d-grid">
        <button id="btnSearch" class="btn btn-outline-primary">
          검색
        </button>
      </div>
      <div class="col-auto d-grid">
        <button id="btnRefresh" class="btn btn-secondary">
          새로고침
        </button>
      </div>
      <div class="col-auto d-grid">
        <button
          class="btn btn-success"
          data-bs-toggle="modal"
          data-bs-target="#uploadModal"
        >
          엑셀 업로드
        </button>
      </div>
      <div class="col-auto d-grid">
        <button id="btnDeleteAll" class="btn btn-danger">
          전체 삭제
        </button>
      </div>
    </div>
    <% if (typeof latestInfo !== 'undefined' && latestInfo && latestInfo.createdAt) { %>
        <div class="text-end text-muted small mb-3">
          📝 마지막 업로드: <%= new Date(latestInfo.createdAt).toLocaleString('ko-KR') %> (<%= latestInfo.uploadedBy || '알 수 없음' %>)
        </div>
      <% } %>
      

    <!-- 재고 테이블 -->
    <table
      id="stockTable"
      class="table table-bordered table-hover w-100 align-middle"
    >
      <thead class="table-light">
        <tr>
          <th>품번</th>
          <th>품명</th>
          <th>색상</th>
          <th>사이즈</th>
          <th>수량</th>
          <th>할당</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>


  <!-- 엑셀 업로드 모달 -->
  <div
    class="modal fade"
    id="uploadModal"
    tabindex="-1"
    aria-labelledby="uploadModalLabel"
  >
    <div class="modal-dialog">
      <form id="uploadForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">엑셀 업로드</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <input
            type="file"
            name="excelFile"
            accept=".xlsx,.xls"
            class="form-control"
            required
          />
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">업로드</button>
        </div>
      </form>
    </div>
  </div>

          <% for (let i = startPage; i <= endPage; i++) { %>
            <li class="page-item <%= i === 현재페이지 ? 'active' : '' %>">
              <a class="page-link" href="<%= baseUrl + i %>"><%= i %></a>
            </li>
          <% } %>

          <% if (endPage < 전체페이지수) { %>
            <li class="page-item disabled"><span class="page-link">...</span></li>
            <li class="page-item">
              <a class="page-link" href="<%= baseUrl + (endPage + 1) %>">다음 »</a>
            </li>
          <% } %>
        </ul>
      </nav>
    <% } %>

  <!-- 정렬 스크립트 -->
  <script>
    const getCellValue = (tr, idx) => tr.children[idx].textContent.trim();
    const toNumber = (v) => {
      const n = parseFloat(v.replace(/,/g, ''));
      return isNaN(n) ? null : n;
    };
    const comparer = (idx, asc) => (a, b) => {
      const v1 = getCellValue(asc ? a : b, idx);
      const v2 = getCellValue(asc ? b : a, idx);
      const n1 = toNumber(v1), n2 = toNumber(v2);
      if (n1 !== null && n2 !== null) return n1 - n2;
      if (n1 === null && n2 === null) return 0;
      if (n1 === null) return 1;
      return -1;
      if (n1 === null && n2 === null) return 0;
      if (n1 === null) return 1;
      return -1;
    };

    document.querySelectorAll('th.sortable').forEach(th => th.addEventListener('click', () => {
      const table = th.closest('table');
      const asc = th.dataset.asc !== 'true';
      Array.from(table.querySelectorAll('tbody tr'))
        .sort(comparer(parseInt(th.dataset.index), asc))
        .forEach(tr => table.tBodies[0].appendChild(tr));

      document.querySelectorAll('th.sortable').forEach(t => {
        t.dataset.asc = '';
        t.querySelector('.sort-indicator').textContent = '';
      });

      th.dataset.asc = asc ? 'true' : 'false';
      th.querySelector('.sort-indicator').textContent = asc ? '▲' : '▼';
      document.querySelectorAll('.sort-select').forEach(sel => sel.value = '');
    }));

    document.querySelectorAll('.sort-select').forEach(sel => {
      sel.addEventListener('change', () => {
        if (!sel.value) return;
        const table = sel.closest('table');
        const idx = parseInt(sel.dataset.index);
        const asc = sel.value === 'asc';

        Array.from(table.querySelectorAll('tbody tr'))
          .sort(comparer(idx, asc))
          .forEach(tr => table.tBodies[0].appendChild(tr));

        document.querySelectorAll('th.sortable').forEach(t => {
          t.dataset.asc = '';
          t.querySelector('.sort-indicator').textContent = '';
        });

        document.querySelectorAll('.sort-select').forEach(other => {
          if (other !== sel) other.value = '';
        });

        const th = table.querySelector(`th.sortable[data-index="${idx}"]`);
        if (th) {
          th.dataset.asc = asc ? 'true' : 'false';
          th.querySelector('.sort-indicator').textContent = asc ? '▲' : '▼';
        }
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 프론트 기능 JS -->
  <script src="/js/stock.js"></script>
</body>
</html>

